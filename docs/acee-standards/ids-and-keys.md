# IDs and Keys

> Standards for identifiers and idempotency keys across ACEE projects.

## 1. ID Formats

### tableId
- **Format**: UUID v4
- **Example**: `550e8400-e29b-41d4-a716-446655440000`
- **Generated By**: Platform (on game enter)
- **Lifetime**: Duration of table session
- **Usage**: Identifies a specific game table

### handId
- **Format**: UUID v4
- **Example**: `123e4567-e89b-12d3-a456-426614174000`
- **Generated By**: Game server (on hand start)
- **Lifetime**: Single hand
- **Usage**: Identifies a specific hand for settlement and audit

### tournamentId
- **Format**: Flexible string (UUID or custom)
- **Examples**: 
  - `tournament-1`
  - `789e0123-e45b-67c8-d901-234567890abc`
- **Generated By**: Platform (on tournament creation)
- **Lifetime**: Duration of tournament
- **Usage**: Groups tables/hands into a tournament

### userId
- **Format**: Flexible string (UUID or custom)
- **Examples**:
  - `user-1`
  - `550e8400-e29b-41d4-a716-446655440000`
  - `wallet_0xabc123...`
- **Generated By**: Platform (on user registration)
- **Lifetime**: Permanent
- **Usage**: Identifies a user across all systems

### sessionId (sid)
- **Format**: UUID v4
- **Example**: `session-123e4567-e89b-12d3-a456-426614174000`
- **Generated By**: Platform (on game enter)
- **Lifetime**: Duration of gameToken validity (10 minutes)
- **Usage**: Links a game session to a user entry

## 2. Idempotency Keys

### settlementId
- **Format**: `${tableId}:${handId}`
- **Example**: `550e8400-e29b-41d4-a716-446655440000:123e4567-e89b-12d3-a456-426614174000`
- **Generated By**: Game server (on hand completion)
- **Purpose**: Prevents duplicate settlement processing
- **Storage**: Platform stores in `game_settlements.settlement_id`

**Implementation**:
```typescript
const settlementId = `${tableId}:${handId}`;
```

### clientMsgId
- **Format**: UUID v4
- **Example**: `789e0123-e45b-67c8-d901-234567890abc`
- **Generated By**: Client (for each action)
- **Purpose**: Prevents duplicate action processing
- **TTL**: 60 seconds in server cache

**Implementation**:
```typescript
const clientMsgId = crypto.randomUUID();
const message = {
  type: 'action',
  clientMsgId,
  action: 'raise',
  amount: 100
};
```

## 3. Idempotency Rules

### Settlement Idempotency

1. **First Request**:
   - Check if `settlementId` exists in database
   - If not, process settlement and store
   - Return `{ ok: true, duplicate: false }`

2. **Duplicate Request**:
   - Find existing settlement by `settlementId`
   - Do NOT reprocess
   - Return `{ ok: true, duplicate: true }`

**Code Pattern**:
```typescript
async function handleSettlement(event: SettlementEvent) {
  const existing = await db.query.gameSettlements.findFirst({
    where: eq(gameSettlements.settlementId, event.settlementId)
  });
  
  if (existing) {
    return { ok: true, duplicate: true };
  }
  
  await db.insert(gameSettlements).values({
    settlementId: event.settlementId,
    tableId: event.tableId,
    handId: event.handId,
    payload: event,
    createdAt: new Date()
  });
  
  return { ok: true, duplicate: false };
}
```

### Action Idempotency

1. **Cache Structure**:
   ```typescript
   Map<clientMsgId, { result: ActionResult, timestamp: number }>
   ```

2. **TTL**: 60 seconds (entries older than 60s are evicted)

3. **On Duplicate**:
   - Return cached `action_result`
   - Do NOT re-apply state change

**Code Pattern**:
```typescript
const TTL_MS = 60_000;

function checkIdempotency(clientMsgId: string): ActionResult | null {
  const entry = cache.get(clientMsgId);
  if (!entry) return null;
  
  if (Date.now() - entry.timestamp > TTL_MS) {
    cache.delete(clientMsgId);
    return null;
  }
  
  return entry.result;
}

function cacheResult(clientMsgId: string, result: ActionResult): void {
  cache.set(clientMsgId, { result, timestamp: Date.now() });
}
```

## 4. Generation Guidelines

### When to Generate UUIDs
- Use `crypto.randomUUID()` (Node.js/browser)
- Never use sequential IDs for public-facing identifiers
- Never reuse IDs across different entity types

### ID Validation
- Always validate UUID format on API boundaries
- Reject malformed IDs with clear error messages

**Validation Pattern**:
```typescript
const UUID_REGEX = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;

function isValidUUID(id: string): boolean {
  return UUID_REGEX.test(id);
}
```

## 5. Database Schema

### game_settlements Table
```sql
CREATE TABLE game_settlements (
  id VARCHAR PRIMARY KEY DEFAULT gen_random_uuid(),
  settlement_id VARCHAR NOT NULL UNIQUE,
  table_id VARCHAR NOT NULL,
  tournament_id VARCHAR,
  hand_id VARCHAR NOT NULL,
  payload JSONB NOT NULL,
  created_at TIMESTAMP DEFAULT NOW() NOT NULL
);

CREATE UNIQUE INDEX game_settlements_settlement_id_unique 
  ON game_settlements(settlement_id);

CREATE INDEX game_settlements_table_id_idx 
  ON game_settlements(table_id, created_at);
```

---

*Reference: [TRUTH_SUMMARY.md](../TRUTH_SUMMARY.md)*

